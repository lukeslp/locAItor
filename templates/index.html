<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>locAItor</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Use Flask's url_for for static asset handling -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <!-- markdown-it for rendering -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
</head>
<body>
  <div class="main-container">
    <h1 class="page-title">locAItor</h1>
    <div class="upload-section">
      <div id="dropZone" class="upload-dropzone">Drag &amp; drop an image here<br>or click to choose one</div>
      <input type="file" id="fileInput" accept="image/*"/>
      <div id="progressIndicator" class="progress-indicator" style="display:none;">Ready</div>
      <div class="profile-image-wrapper" id="profileImageWrapper" style="display:none;">
        <img id="preview" class="profile-image" tabindex="0" alt="Image preview"/>
      </div>
    </div>
    <div class="results-section">
      <!-- Hide LLM output area by default -->
      <div id="llm-output" aria-live="polite" class="llm-streaming-response" style="display:none;"></div>
      <section id="metaSection" style="display:none; text-align:left; margin-top:1.5rem;" aria-labelledby="metaHeading">
        <h2 id="metaHeading" class="meta-heading">Image Metadata & AI Detection</h2>
        <div id="metaContent"></div>
        <div id="provenanceSection"></div>
        <div id="gpsSection" style="margin-top:1em;"></div>
        <div id="mapSection" style="margin-top:1em;"></div>
        <details style="margin-top:1em;"><summary><strong>Raw Metadata (JSON)</strong></summary><pre id="rawMeta" style="font-size:0.95em; background:#f8f8f8; border-radius:4px; padding:0.5em;"></pre></details>
        <div style="margin-top:1em; display:flex; gap:1em; flex-wrap:wrap;">
          <button id="downloadReport" class="brand-btn" aria-label="Download analysis report as JSON">Download Report</button>
          <button id="downloadLogs" class="brand-btn" aria-label="Download server logs">Download Logs</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal for gallery view -->
  <div id="galleryModal" class="gallery-modal" tabindex="-1" aria-modal="true" role="dialog" style="display:none;">
    <div class="gallery-modal-content">
      <span id="closeModal" class="gallery-modal-close" tabindex="0" aria-label="Close gallery">&times;</span>
      <img id="modalImage" class="gallery-modal-image" alt="Full size image preview"/>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <script>
    const DZ = document.getElementById('dropZone'),
          FI = document.getElementById('fileInput'),
          PV = document.getElementById('preview'),
          PI = document.getElementById('progressIndicator'),
          PIW = document.getElementById('profileImageWrapper'),
          RS = document.getElementById('llm-output'),
          md = window.markdownit(),
          MS = document.getElementById('metaSection'),
          MC = document.getElementById('metaContent'),
          PROV = document.getElementById('provenanceSection'),
          GPS = document.getElementById('gpsSection'),
          MAP = document.getElementById('mapSection'),
          RAW = document.getElementById('rawMeta'),
          MODAL = document.getElementById('galleryModal'),
          MODAL_IMG = document.getElementById('modalImage'),
          CLOSE_MODAL = document.getElementById('closeModal');

    DZ.onclick = () => FI.click();
    ['dragenter','dragover'].forEach(e =>
      DZ.addEventListener(e, ev => { ev.preventDefault(); DZ.classList.add('dragover'); })
    );
    ['dragleave','drop'].forEach(e =>
      DZ.addEventListener(e, ev => { ev.preventDefault(); DZ.classList.remove('dragover'); })
    );

    DZ.addEventListener('drop', ev => {
      if (ev.dataTransfer.files.length) handleImage(ev.dataTransfer.files[0]);
    });
    FI.onchange = ev => {
      if (ev.target.files.length) handleImage(ev.target.files[0]);
    };

    // Profile image click/keyboard for gallery modal
    PV.onclick = () => showGallery();
    PV.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') showGallery(); };
    function showGallery() {
      if (!PV.src) return;
      MODAL_IMG.src = PV.src;
      MODAL.style.display = 'flex';
      MODAL.focus();
    }
    CLOSE_MODAL.onclick = () => { MODAL.style.display = 'none'; };
    CLOSE_MODAL.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') MODAL.style.display = 'none'; };
    MODAL.onclick = (e) => { if (e.target === MODAL) MODAL.style.display = 'none'; };

    async function handleImage(file) {
      DZ.style.display = 'none';
      PIW.style.display = 'none'; // Hide image preview area
      PV.style.display = 'none';
      PV.src = '';
      if (PI) { PI.style.display = 'block'; PI.textContent = 'Uploading image...'; }
      if (RS) {
        RS.style.display = 'none';
        RS.textContent   = '';
      }
      MS.style.display = 'none';
      MC.innerHTML     = '';
      PROV.innerHTML   = '';
      GPS.innerHTML    = '';
      MAP.innerHTML    = '';
      RAW.textContent  = '';

      // --- HEIC preview support ---
      const isHeic = file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic');
      if (isHeic && window.heic2any) {
        try {
          if (PI) PI.textContent = 'Converting HEIC image...';
          const blob = await heic2any({ blob: file, toType: 'image/jpeg' });
          PV.src = URL.createObjectURL(blob);
          PV.style.display = 'block';
          PIW.style.display = 'block';
        } catch (e) {
          PV.style.display = 'none';
          PIW.style.display = 'none';
          PV.alt = 'Preview not available (HEIC conversion failed)';
        }
      } else {
        PV.src = URL.createObjectURL(file);
        PV.style.display = 'block';
        PIW.style.display = 'block';
      }
      if (PI) PI.textContent = 'Analyzing image metadata...';

      const form = new FormData();
      form.append('image', file);

      try {
        // Streaming LLM answer with metadata-first protocol
        let streamed = false;
        if (window.ReadableStream) {
          const resp = await fetch('/analyze?stream=1', { method:'POST', body: form });
          if (resp.ok && resp.body && resp.headers.get('content-type') === 'text/plain') {
            streamed = true;
            let progressState = 0;
            const reader = resp.body.getReader();
            let decoder = new TextDecoder();
            let text = '';
            let firstChunk = true;
            let metaObj = null;
            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              const chunk = decoder.decode(value, {stream:true});
              if (firstChunk) {
                if (PI) PI.textContent = 'Processing with AI...';
                const nlIdx = chunk.indexOf('\n');
                let metaLine = chunk, rest = '';
                if (nlIdx !== -1) {
                  metaLine = chunk.slice(0, nlIdx);
                  rest = chunk.slice(nlIdx+1);
                }
                try {
                  metaObj = JSON.parse(metaLine);
                  renderMetadata(metaObj); // Show metadata/map immediately
                  if (PI) PI.textContent = 'Waiting for AI response...';
                } catch (e) {
                  MC.innerHTML = '<div style="color:#b00;">Failed to parse metadata from server.</div>';
                  if (PI) PI.textContent = 'Error parsing metadata.';
                }
                if (rest) {
                  text += rest;
                  RS.innerHTML = md.render(text);
                  RS.style.display = text.trim() ? 'block' : 'none';
                  if (PI) PI.style.display = 'none';
                }
                firstChunk = false;
              } else {
                text += chunk;
                RS.innerHTML = md.render(text);
                RS.style.display = text.trim() ? 'block' : 'none';
                if (PI) PI.style.display = 'none';
              }
            }
            if (PI) PI.style.display = 'none';
            return;
          }
        }
        if (!streamed) {
          if (PI) PI.textContent = 'Processing with AI...';
          const resp = await fetch('/analyze', { method:'POST', body: form });
          const j    = await resp.json();
          if (j.error) {
            RS.innerHTML = `<div style='color:#b00;'>${j.error}</div>`;
            RS.style.display = 'block';
            MS.style.display = 'none';
            if (PI) PI.style.display = 'none';
            return;
          }
          if (!j.metadata) {
            RS.innerHTML = `<div style='color:#b00;'>No metadata returned from server.</div>`;
            RS.style.display = 'block';
            MS.style.display = 'none';
            if (PI) PI.style.display = 'none';
            return;
          }
          renderMetadata(j); // Show metadata/map first
          const text = j.content || j.error;
          RS.innerHTML = md.render(text);
          RS.style.display = text && text.trim() ? 'block' : 'none';
          if (PI) PI.style.display = 'none';
        }
      } catch (err) {
        RS.textContent = 'Error: ' + err.message;
        RS.style.display = 'block';
        MS.style.display = 'none';
        if (PI) PI.style.display = 'none';
      }
    }

    // Download Report and Logs handlers
    document.addEventListener('DOMContentLoaded', function() {
      const reportBtn = document.getElementById('downloadReport');
      const logsBtn = document.getElementById('downloadLogs');
      if (reportBtn) {
        reportBtn.onclick = async function() {
          try {
            const resp = await fetch('/report');
            if (!resp.ok) throw new Error('No report available yet.');
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'analysis_report.json';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
          } catch (e) {
            alert('Could not download report: ' + e.message);
          }
        };
      }
      if (logsBtn) {
        logsBtn.onclick = async function() {
          try {
            const resp = await fetch('/logs');
            if (!resp.ok) throw new Error('No logs available.');
            const disposition = resp.headers.get('Content-Disposition');
            let filename = 'app.log';
            if (disposition && disposition.indexOf('filename=') !== -1) {
              filename = disposition.split('filename=')[1].replace(/"/g, '');
            }
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
          } catch (e) {
            alert('Could not download logs: ' + e.message);
          }
        };
      }
    });

    // Collapsible panels JS (W3Schools pattern, accessible)
    function initCollapsibles() {
      var coll = document.getElementsByClassName("collapsible");
      for (let i = 0; i < coll.length; i++) {
        coll[i].onclick = function() {
          this.classList.toggle("active");
          var content = this.nextElementSibling;
          var expanded = this.getAttribute('aria-expanded') === 'true';
          this.setAttribute('aria-expanded', !expanded);
          content.setAttribute('aria-hidden', expanded);
          if (content.style.display === "block") {
            content.style.display = "none";
          } else {
            content.style.display = "block";
          }
        };
        coll[i].setAttribute('aria-expanded', 'false');
        if (coll[i].nextElementSibling) {
          coll[i].nextElementSibling.style.display = 'none';
          coll[i].nextElementSibling.setAttribute('aria-hidden', 'true');
        }
      }
    }

    // --- Render metadata and map from metadata object (for streaming and fallback) ---
    function renderMetadata(j) {
      if (!j || !j.metadata) return;
      MS.style.display = 'block'; // Show metadata/map area immediately
      // j: { metadata, gps, address }
      const hasGps = j.gps && typeof j.gps.lat === 'number' && typeof j.gps.lon === 'number';
      const gpsDisplay = hasGps ? `${j.gps.lat.toFixed(6)}, ${j.gps.lon.toFixed(6)}` : (() => {
        let lat = j.metadata?.exif?.GPSLatitude || j.metadata?.heic_exif?.GPSLatitude;
        let lon = j.metadata?.exif?.GPSLongitude || j.metadata?.heic_exif?.GPSLongitude;
        if (lat && lon) return `${lat}, ${lon}`;
        return '—';
      })();
      // ---
      let html = '';
      html += `<div><strong>AI Generated:</strong> <span aria-live="polite">${j.metadata.ai_generated === null ? 'Unknown' : (j.metadata.ai_generated ? 'Yes' : 'No')}</span></div>`;
      html += `<div><strong>Reason:</strong> <span>${j.metadata.ai_reason || ''}</span></div>`;
      html += '<table class="meta-summary"><tr><td><strong>Camera Model</strong></td><td>' + (j.metadata.exif?.Model || j.metadata.heic_exif?.Model || '—') + '</td></tr>';
      html += '<tr><td><strong>Date Taken</strong></td><td>' + (j.metadata.exif?.DateTimeOriginal || j.metadata.heic_exif?.DateTimeOriginal || '—') + '</td></tr>';
      html += '<tr><td><strong>GPS</strong></td><td>' + gpsDisplay + '</td></tr>';
      html += '<tr><td><strong>Software</strong></td><td>' + (j.metadata.provenance?.software || '—') + '</td></tr>';
      html += '<tr><td><strong>Creator Tool</strong></td><td>' + (j.metadata.provenance?.creator_tool || '—') + '</td></tr>';
      html += '</table>';
      html += '<button type="button" class="collapsible" aria-expanded="false">EXIF Metadata</button>';
      html += '<div class="collapsible-content" aria-hidden="true"><pre>' + JSON.stringify(j.metadata.exif || {}, null, 2) + '</pre></div>';
      html += '<button type="button" class="collapsible" aria-expanded="false">HEIC EXIF Metadata</button>';
      html += '<div class="collapsible-content" aria-hidden="true">';
      if (j.metadata.heic_exif && Object.keys(j.metadata.heic_exif).length) {
        if (j.metadata.heic_exif.error) {
          html += `<div style="color:#b00; background:#2C2F33; border-radius:6px; padding:0.5em; margin-bottom:0.5em;">⚠️ <strong>HEIC EXIF extraction failed:</strong> ${j.metadata.heic_exif.error} <br>This is a technical limitation, not a sign of AI generation.</div>`;
        } else {
          html += '<pre>' + JSON.stringify(j.metadata.heic_exif, null, 2) + '</pre>';
        }
      } else {
        html += '<pre>{}</pre>';
      }
      html += '</div>';
      html += '<button type="button" class="collapsible" aria-expanded="false">XMP/ICC Metadata</button>';
      html += '<div class="collapsible-content" aria-hidden="true"><pre>' + JSON.stringify(j.metadata.xmp_icc || {}, null, 2) + '</pre></div>';
      html += '<div class="button-row"><button id="downloadReport" class="brand-btn" aria-label="Download analysis report as JSON">Download Report</button>';
      html += '<button id="downloadLogs" class="brand-btn" aria-label="Download server logs">Download Logs</button></div>';
      MC.innerHTML = html;
      // Provenance
      if (j.metadata && j.metadata.provenance) {
        let prov = j.metadata.provenance;
        let provHtml = '<h3>Provenance</h3><ul class="provenance-list">';
        for (const [k, v] of Object.entries(prov)) {
          provHtml += `<li><strong>${k.replace(/_/g,' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> <span>${String(v)}</span></li>`;
        }
        provHtml += '</ul>';
        PROV.innerHTML = provHtml;
      } else {
        PROV.innerHTML = '<h3>Provenance</h3><div style="color:#888;">No provenance metadata found.</div>';
      }
      // --- Map ---
      MAP.innerHTML = '<div id="map" style="height:350px; border-radius:8px;"></div>';
      setTimeout(() => {
        if (window.L && document.getElementById('map')) {
          try {
            let map, marker;
            if (j.gps && typeof j.gps.lat === 'number' && typeof j.gps.lon === 'number') {
              const lat = j.gps.lat;
              const lon = j.gps.lon;
              map = L.map('map', {scrollWheelZoom: false, attributionControl: true}).setView([lat, lon], 13);
              marker = L.marker([lat, lon], {keyboard: true, alt: 'Photo location marker'}).addTo(map)
                .bindPopup(`<strong>Location:</strong><br>${lat.toFixed(6)}, ${lon.toFixed(6)}`).openPopup();
            } else {
              map = L.map('map', {scrollWheelZoom: false, attributionControl: true}).setView([0, 0], 2);
            }
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '© OpenStreetMap contributors',
              errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+P+/HgAEDQIHq4C7sgAAAABJRU5ErkJggg=='
            }).addTo(map);
            setTimeout(() => { map.invalidateSize(); }, 200);
          } catch (e) {
            console.error('Map rendering error:', e);
            MAP.innerHTML = `<div style="color:#b00; background:#2C2F33; border-radius:6px; padding:0.8em; line-height:1.4;">⚠️ <strong>Map could not be rendered:</strong> ${e.message}</div>`;
          }
        } else {
          console.error('Leaflet not loaded or map container not found');
          MAP.innerHTML = `<div style="color:#b00; background:#2C2F33; border-radius:6px; padding:0.8em; line-height:1.4;">⚠️ <strong>Map library not loaded.</strong></div>`;
        }
      }, 300);
      RAW.textContent = JSON.stringify(j.metadata, null, 2);
      if (j.metadata && j.metadata.exif_orig) {
        MC.innerHTML += '<button type="button" class="collapsible" aria-expanded="false">Original EXIF Metadata</button>';
        MC.innerHTML += '<div class="collapsible-content" aria-hidden="true"><pre>' + JSON.stringify(j.metadata.exif_orig || {}, null, 2) + '</pre></div>';
      }
      // --- Re-initialize collapsibles after dynamic content injection ---
      initCollapsibles();
    }
  </script>
</body>
</html>